#!/bin/bash
#
# Usage: pull
#
# Pulls remote changes using rebase & tries to rebundle,
# safely stashing and re-applying your local changes, if any
#

# Colors
color_error="$(tput sgr 0 1)$(tput setaf 1)"
color_reset="$(tput sgr0)"

# Pop any stashed changes
unstash() {
  if [[ ! "$stash" =~ "No local changes to save" ]]; then
    echo
    echo "🍯  Popping stash..."
    git stash pop
  fi
}

# Pop any stashed changes and exit
rollback() {
  echo
  echo "${color_error}Something went wrong, rolling back${color_reset}"
  unstash
  exit $1
}




branch=$(git branch --no-color 2>/dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/\1/') || exit $?
default_remote="origin"
remote=$(git config "branch.${branch}.remote" || echo "$default_remote")
remote_branch=$( (git config "branch.${branch}.merge" || echo "refs/heads/$branch") | cut -d/ -f3- )


# Stash any local changes
stash=$(git stash)

# Update our remote
echo "🚀  Fetching from $remote..."
git fetch $remote || rollback $?

# Pull, using rebase if configured
rebase="--rebase" # TODO disable if env-var is set
git pull $rebase $remote $remote_branch || rollback $?

# get changed files for install check
changed_files="$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD)"

# Update submodules
git submodule update || rollback $?

unstash

# Remove old, stale branches
git remote prune $remote >/dev/null 2>&1 &



# get directory of changed file
get_dir() {
	base=$(git rev-parse --show-cdup)
	file=$(git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD | grep "$1")
	dirname "./$base$file"
}

# only run if specific file changed
check_run() {
	echo "$changed_files" | grep --quiet "$1" && cd $(get_dir "$1") && echo && echo "$2" && eval "$3"
}


# Bundle em if you got em!
if [ "$GIT_FRIENDLY_NO_BUNDLE" != "true" ]; then
  if which bundle >/dev/null 2>&1 && [ -f Gemfile ]; then
    check_run Gemfile "⚔  Bundling gems..." "bundle check >/dev/null 2>&1 || bundle install"
  fi
fi

# Install Node.js packages with Yarn
if [ "$GIT_FRIENDLY_NO_YARN" != "true" ]; then
  if which npm >/dev/null 2>&1 && [ -f yarn.lock ]; then
    check_run yarn.lock "⚔  Installing npm packages..." "yarn install"
  fi
fi

# Install Node.js packages with npm
if [ "$GIT_FRIENDLY_NO_NPM" != "true" ]; then
  if which npm >/dev/null 2>&1 && ( [ ! -f yarn.lock ] || [ "$GIT_FRIENDLY_NO_YARN" == "true" ] ) && [ -f package.json ]; then
    check_run package.json "⚔  Installing npm packages..." "npm install"
  fi
fi

# Install Bower components
if [ "$GIT_FRIENDLY_NO_BOWER" != "true" ]; then
  if which bower >/dev/null 2>&1 && [ -f bower.json ]; then
    check_run bower.json "⚔  Installing Bower packages..." "bower install"
  fi
fi

# Install Composer packages
if [ "$GIT_FRIENDLY_NO_COMPOSER" != "true" ]; then
  if ( which composer >/dev/null 2>&1 || [ -f ./composer.phar ] ) && which php >/dev/null 2>&1 && [ -f composer.lock ]; then
    check_run composer.lock "⚔  Installing Composer packages..." "[ -f ./composer.phar ] && php composer.phar install || composer install"
  fi
fi

echo
echo "🦄  Done"
exit 0
